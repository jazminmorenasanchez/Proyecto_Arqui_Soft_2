version: "3.9"

name: Arq-soft-2
services:
  mysql:
    build:
      context: ./deploy/mysql
    container_name: Arq-soft-2-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p${DB_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [backend]

  mongo:
    build:
      context: ./deploy/mongo
    container_name: Arq-soft-2-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", 'echo "db.runCommand({ ping: 1 })" | mongosh --quiet']
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [backend]

  solr:
    build:
      context: ./deploy/solr
    container_name: Arq-soft-2-solr
    restart: unless-stopped
    environment:
      SOLR_CORE: ${SOLR_CORE}
    ports:
      - "${SOLR_PORT}:8983"
    volumes:
      - solr_data:/var/solr
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8983/solr/admin/cores?action=STATUS\\&core=${SOLR_CORE} | grep -q '\"name\":\"${SOLR_CORE}\"'"]
      interval: 15s
      timeout: 5s
      retries: 20
    networks: [backend, search]

  rabbitmq:
    build:
      context: ./deploy/rabbitmq
    container_name: Arq-soft-2-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST}
      RABBITMQ_DEFINITIONS_FILE: /etc/rabbitmq/definitions.json
    ports:
      - "${RABBIT_PORT}:5672"
      - "${RABBIT_MGMT_PORT}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [backend]

  memcached:
    build:
      context: ./deploy/memcached
    container_name: Arq-soft-2-memcached
    restart: unless-stopped
    command: ["-m", "${MEMCACHED_MEMORY}"]
    ports:
      - "${MEMCACHED_PORT}:11211"
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc -w 2 127.0.0.1 11211 | grep -q pid"]
      interval: 15s
      timeout: 5s
      retries: 10
    networks: [backend, search]

  users-api:
    build:
      context: ./users-api
    container_name: Arq-soft-2-users-api
    restart: unless-stopped
    environment:
      APP_PORT: "8081"
      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_USER: root
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_DB: ${DB_NAME}
      JWT_SECRET: ${JWT_SECRET:-change_me}
      JWT_EXP_MINUTES: "60"
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
    networks: [backend]

  activities-api:
    build:
      context: ./activities-api
    container_name: Arq-soft-2-activities-api
    restart: unless-stopped
    environment:
      ACTIVITIES_PORT: "8082"
      MONGO_URI: "mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:27017/?authSource=admin"
      MONGO_DB: "sporthub"
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: "5672"
      RABBITMQ_URL: "amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/"
      RABBITMQ_EXCHANGE: activities.events
      RABBITMQ_EXCHANGE_TYPE: topic
      USERS_API_BASE_URL: "http://users-api:8081"
      JWT_SECRET: ${JWT_SECRET:-change_me}
    ports:
      - "8082:8082"
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [backend, search]

  search-api:
    build:
      context: ./search-api
    container_name: Arq-soft-2-search-api
    restart: unless-stopped
    environment:
      SEARCH_API_PORT: "8083"
      SOLR_URL: "http://solr:8983/solr/sporthub_core"
      MEMCACHED_ADDR: "memcached:11211"
      CACHE_TTL_SECONDS: "60"
      RABBIT_URL: "amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq:5672/"
      RABBIT_EXCHANGE: activities.events
      RABBIT_QUEUE: search_sync
      RABBIT_ROUTING_KEY: "activity.session.*"
      ACTIVITIES_API_BASE: "http://activities-api:8082"
    ports:
      - "8083:8083"
    depends_on:
      solr:
        condition: service_healthy
      memcached:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      activities-api:
        condition: service_started
    networks: [backend, search]

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_USERS_API_URL: "http://localhost:8081"
        NEXT_PUBLIC_ACTIVITIES_API_URL: "http://localhost:8082"
        NEXT_PUBLIC_SEARCH_API_URL: "http://localhost:8083"
    container_name: Arq-soft-2-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      users-api:
        condition: service_started
      activities-api:
        condition: service_started
      search-api:
        condition: service_started
    networks: [backend]

networks:
  backend:
  search:

volumes:
  mysql_data:
  mongo_data:
  solr_data:
